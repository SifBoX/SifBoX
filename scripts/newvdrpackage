#!/bin/sh

PACKAGE="$1"

if [ -z "$PACKAGE" ]; then
  echo "Usage: newpackage <packagename>"
  exit 1
fi

mkdir -p packages/multimedia/$PACKAGE

cat > packages/multimedia/$PACKAGE/meta <<EOF
PKG_NAME=$PACKAGE
PKG_VERSION=0.0invalid
PKG_URL_PROTO=git
PKG_URL_REV=00000
PKG_URL="git://projects.vdr-developer.org/"
PKG_REV=1
PKG_DEPENDS="\$TARGET_LIBC vdr"
PKG_BUILD_DEPENDS="toolchain vdr"
PKG_PRIORITY=optional
PKG_SECTION=multimedia
PKG_SHORTDESC="$PACKAGE (autogenerated)"
PKG_LONGDESC=""
EOF

cat > packages/multimedia/$PACKAGE/build <<EOF

#!/bin/sh

. config/options

get_meta vdr
VDR_VERSION=\$PKG_VERSION

get_meta linux
DVB_DIR="\$SYSROOT_PREFIX/usr/include"

get_meta \$1
VDR_DIR=\`basename \$BUILD/vdr-\$VDR_VERSION\`

cd \$PKG_BUILD_DIR

make all \\
  VDRDIR="../\$VDR_DIR" \\
  DVBDIR=\$DVB_DIR \\
  LIBDIR="." \\
  LOCALEDIR="./locale" \\

make_install
rm -rf .install-debuginfo || true

EOF
chmod +x packages/multimedia/$PACKAGE/build

cat > packages/multimedia/$PACKAGE/install <<EOF
#!/bin/sh

. config/options

get_meta vdr
verlte 1.7.36 \$PKG_VERSION && VDRINS="no" || VDRINS="yes"

get_meta \$1
cd \$PKG_BUILD_DIR

NAME=\`echo \$1 | sed s/vdr-//\`
mkdir -p \$INSTALL/etc/vdr/plugins.d
echo "PLUGIN=\${NAME}" > \$INSTALL/etc/vdr/plugins.d/50_\$NAME
echo "ENABLED=yes" >> \$INSTALL/etc/vdr/plugins.d/50_\$NAME

if [ \$VDRINS = "no" ]; then
  mkdir -p \$INSTALL/usr/lib/vdr/plugins
  cp -a lib\$1*.so.* \$INSTALL/usr/lib/vdr/plugins
  for loc in \$INCLUDED_LOCALES; do
  LOCALE=\`echo \$loc|cut -f1 -d.\`
    if [ -d locale/\$LOCALE ]; then
      mkdir -p \$INSTALL/usr/share/locale/\$LOCALE
      cp -a locale/\$LOCALE/* \$INSTALL/usr/share/locale/\$LOCALE/
    fi
  done
else
  do_install usr
fi

EOF
chmod +x packages/multimedia/$PACKAGE/install
